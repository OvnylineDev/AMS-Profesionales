<!doctype html>
<html lang="es-ES">

<head>
	<meta charset="utf-8" />
	<meta http-equiv="x-ua-compatible" content="ie=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no" />
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" /><meta http-equiv="Last-Modified" content="0">
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />
	<title>Gestión de Intervenciones 1.0</title>
	<script src="./resources/js/jq.js"></script>

	<script type="text/javascript" src="./resources/js/gv.js"></script>

	<script type="text/javascript" src="cordova.js"></script>
	<script type="text/javascript" src="./resources/js/pg.js"></script>

	<script src="./resources/js/sp.js"></script>

	<script src="./resources/datepicker/datepicker.js"></script>

	<link href="./resources/css/w3.css" rel="stylesheet">
	<link href="./resources/css/style.css" rel="stylesheet">
	<link href="./resources/fa/css/font-awesome.css" rel="stylesheet">
	<link href="./resources/datepicker/datepicker.css" rel="stylesheet">
</head>

<body class="w3-large">
	<div id="top" class="w3-padding-large w3-large w3-red">
		<div id="titulo">

		</div>
		<div id="login">
			<a class="opt" destino="principal.html"><i class="fa fa-list" aria-hidden="true"></i></a>
			<a class="opt" destino="fest-general.html"><i class="fa fa-file-text-o " aria-hidden="true"></i></a>
			<a class="opt" destino="reload"><i class="fa fa-refresh" aria-hidden="true"></i></a>
			<a class="opt" destino="index.html"><i class="fa fa-power-off" aria-hidden="true"></i></a>
		</div>
	</div>
	<div id="info" class="w3-padding-large w3-border">

	</div>
	<div id="botones" class="w3-padding-large">
		<div id="navegador" class="w3-cell-row w3-center" style="width:100%">
			<div class="topnav" id="sections">
				<a class="sect disabled" destino="llamada.html">Llamada</a>
				<a class="sect" destino="historial.html">Historial</a>
				<a class="sect" destino="seguimiento.html">Observaciones</a>
				<a class="sect" destino="foto.html">Fotografías</a>
				<a class="sect" destino="planos.html">Planos/Diseños</a>
				<a class="sect" destino="parte.html">Parte Final</a>
				<a class="sect" destino="fincita.html">Fin Cita</a>
				<a id="val" class="sect" destino="val-general.html">Valoración/Presupuesto</a>
				<a href="javascript:void(0);" class="icon" onclick="showTopNav()"><i class="fa fa-bars" aria-hidden="true"></i></a>
			</div>
		</div>

		<div class="w3-light-grey w3-center w3-round w3-padding-16" style="width:100%;margin-bottom:16px">
			<div class="w3-center w3-padding-16">
				<div class="w3-cell-row w3-center">
					<div class="w3-cell-row w3-mobile w3-container">
						<i class="fa fa-calendar" aria-hidden="true"></i> <span id="fechaCita">--/--/--</span>
					</div>
					<div class="w3-cell-row w3-mobile w3-center  w3-container w3-padding-16 w3-border-top w3-border-bottom">
						<span id="nophone" style="color: gray;" class="fa-stack fa-5x fa-lg phone">
							<i class="fa fa-circle fa-stack-2x"></i>
							<i class="fa fa-phone fa-stack-1x fa-inverse" aria-hidden="true"></i>
						</span>
						<!-- <a id="mobincall" href="mobincube://action/call/00361346734"> -->
							<span id="phone" style="color: green; display:none;" class="fa-stack fa-5x fa-lg phone" seleccionado="">
								<i class="fa fa-circle fa-stack-2x"></i>
								<i class="fa fa-phone fa-stack-1x fa-inverse" aria-hidden="true"></i>
							</span>
						<!-- </a> -->
						<span id="phonecall" style="color: red; display:none;" class="fa-rotate-135 fa-stack fa-5x fa-lg phonecall">
							<i class="fa fa-circle fa-stack-2x"></i>
							<i class="fa fa-phone fa-stack-1x fa-inverse" aria-hidden="true"></i>
						</span>
						<div id="tlfnoselec" class="w3-cell-row w3-mobile w3-container">
							Seleccione un número de contacto de la lista inferior
						</div>
						<div id="tlfselec" style="display:none;" class="w3-cell-row w3-mobile w3-container">
							<i class="fa fa-phone-square" aria-hidden="true"></i> Número seleccionado: <span>--- ------</span>
						</div>
					</div>
					<div class="w3-cell-row w3-mobile w3-container">
						<i class="fa fa-user-circle" aria-hidden="true"></i> <span id="cntc">John Doe</span>
					</div>
					<div class="w3-cell-row w3-mobile w3-container">
						<i class="fa fa-map-marker" aria-hidden="true"></i> <span id="dir">C/ Lorem ipsum</span>
					</div>
				</div>
			</div>
		</div>
		<div class="w3-cell-row">
			<div id="contactos">

			</div>
		</div>
	</div>

	<div id="seg_form" class="w3-padding-large w3-center" style="display:none;">
		<div id="estadollamada">
			<h4>El contacto ha cogido la llamada</h4>
			<div class="radiob">
				<input id="llamadaOK" class="w3-radio" type="radio" name="llamada" value="OK"><label for="llamadaOK">Si</label>
				<input id="llamadaKO" class="w3-radio" type="radio" name="llamada" value="KO"><label for="llamadaKO">No</label>
			</div>
		</div>
		<div id="edfechacita" style="display:none;">
			<h4>Introducir la fecha de la cita - Pulse cuadro para activar</h4>
			<input id="activechange" type="checkbox" name="activechange">
			<input id="datepicker" data-toggle="datepicker" disabled>
			<select id="slhour" disabled>
			<option value="--">--</option>
			<option value=7>07</option>
			<option value=8>08</option>
			<option value=9>09</option>
			<option value=10>10</option>
			<option value=11>11</option>
			<option value=12>12</option>
			<option value=13>13</option>
			<option value=14>14</option>
			<option value=15>15</option>
			<option value=16>16</option>
			<option value=17>17</option>
			<option value=18>18</option>
			<option value=19>19</option>
			<option value=20>20</option>
			<option value=21>21</option>
			<option value=22>22</option>
		</select>
			<select id="slmin" disabled>
			<option value="--">--</option>
			<option value=0>00</option>
			<option value=5>05</option>
			<option value=10>10</option>
			<option value=15>15</option>
			<option value=20>20</option>
			<option value=25>25</option>
			<option value=30>30</option>
			<option value=35>35</option>
			<option value=40>40</option>
			<option value=45>45</option>
			<option value=50>50</option>
			<option value=55>55</option>
		</select>
		</div>
		<div>
			<h4>Introduzca las observaciones de la llamada</h4>
			<textarea id="textcita" class="textfield" cols="30" rows="8"></textarea>
		</div>
	</div>
	<div id="modalexit" class="w3-light-grey w3-round w3-padding modalfull" style="width:100%;margin-bottom:16px">
		<div id="exitframe" class="campo">
			<input id="dest" type="text" name="dest" style="display:none;" disabled="disabled">
			<input id="type" type="text" name="dest" style="display:none;" disabled="disabled">
			<h4 id="mensaje"></h4>
			<button id="exittrue" class="w3-button w3-block w3-green w3-cell w3-right" style="width:50%">Salir</button>
			<button id="exitfalse" class="w3-button w3-block w3-red w3-cell w3-right" style="width:50%">Permanecer</button>
		</div>
	</div>
	<script>
		var token = "";
		var idSerie = "";
		var numeroOrden = "";
		var idExpEst = "";

		var fechaOldArr = null;
		var fechaOld = null;

		$(document).ready(function() {

			//recoger parámetros
			token = gv_get_URL_parameter("token");
			idSerie = gv_get_URL_parameter("idSerie");
			numeroOrden = gv_get_URL_parameter("numeroOrden");

			if (localStorage.length = 0 || token === undefined || idSerie === undefined || numeroOrden === undefined || token == "" || idSerie == "" || numeroOrden == "") {
				logout(token,localStorage.getItem(LOCALIDOP));
			}

			idExpEst = localStorage.getItem(LOCALIDEXPEST);

			//rellenar página con parámetros
			$("#titulo").html("EXPEDIENTE " + idSerie + " " + numeroOrden);

			$("#activechange").prop('checked', false);
			$("#datepicker").prop('disabled', true);
			$("#slhour").prop('disabled', true);
			$("#slmin").prop('disabled', true);
			$("#llamadaKO").prop('checked', true);

			//realizar búsquedas y mostrarlas
			if (navigator.onLine) {
				var params = {
					"op": "contactos",
					"idExpEst": idExpEst,
					"token": token
				};

				$.ajax({
					url: APIURL,
					data: params, //parámetros pasados
					type: 'POST',
					dataType: "json",
					crossDomain: true,
					success: function(jsonrespuesta) {
						// var jsonrespuesta=jQuery.parseJSON(respuesta);

						if (jsonrespuesta.status == "KO") {
							switch (jsonrespuesta.error) {
								case "1":
									$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i>Error de base de datos: ' + jsonrespuesta.message + '.');
									break;
								case "2":
									$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i>Hay un problema con dicho expediente, contacte con el administrador.');
									break;
								case "4":
									$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i>No se encuentran datos de dicho expediente, vuelva a la pantalla <a href="principal.html">principal</a>.');
									break;
								case "99":
									logout(token,localStorage.getItem(LOCALIDOP));
									break;
								default:
									$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i> Ha ocurrido un error desconocido. Posiblemente necesite actualizar la aplicación');;

							}
						}
						if (jsonrespuesta.status == "OK") {

							var html = "";
							html = html + '<table class="w3-table-all"\
									<tr>\
									  <th>Origen</th>\
									  <th>Teléfono</th>\
									</tr>';

							var fechaCita = (jsonrespuesta.items.fechaCita != null) ? jsonrespuesta.items.fechaCita : "Sin Definir";
							var exp_contacto = (jsonrespuesta.items.exp_contacto != null) ? jsonrespuesta.items.exp_contacto : "Sin Definir";
							var exp_telefono = (jsonrespuesta.items.exp_telefono != null) ? jsonrespuesta.items.exp_telefono : "Sin Definir";
							var direccion = (jsonrespuesta.items.direccion != null) ? jsonrespuesta.items.direccion : "Sin Definir";
							var localidad = (jsonrespuesta.items.localidad != null) ? jsonrespuesta.items.localidad : "Sin Definir";
							var codigoPostal = (jsonrespuesta.items.codigoPostal != null) ? jsonrespuesta.items.codigoPostal : "Sin Definir";
							var dir_telefono = (jsonrespuesta.items.dir_telefono != null) ? jsonrespuesta.items.dir_telefono : "Sin Definir";
							var dir_movil = (jsonrespuesta.items.dir_movil != null) ? jsonrespuesta.items.dir_movil : "Sin Definir";
							var client_telefono = (jsonrespuesta.items.client_telefono != null) ? jsonrespuesta.items.client_telefono : "Sin Definir";
							var client_movil = (jsonrespuesta.items.client_movil != null) ? jsonrespuesta.items.client_movil : "Sin Definir";

							if (fechaCita!="Sin Definir") {
								fechaOldArr = fechaCita.split(" | ");
								var horaArr = fechaOldArr[1].split(":");
								var datearray = fechaOldArr[0].split("-");
								fechaOld = new Date(datearray[2], datearray[1]-1, datearray[0], horaArr[0], horaArr[1]);
							}else{
								fechaOldArr = null;
							}

							//fechacitasubc
							var subc = localStorage.getItem(LOCALSUBC) === '1';

							if (subc) {
								$('[data-toggle="datepicker"]').datepicker({
									format: 'dd-mm-yyyy',
									language: 'es-ES',
									weekStart: 1,
									days: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
									date: new Date()
								});

								$("#edfechacita").show();

								if (fechaOldArr!=null) {
									$('[data-toggle="datepicker"]').val(fechaOldArr[0]);
									$('#slhour').val(fechaOld.getHours());
									$('#slmin').val(fechaOld.getMinutes());
									$('[data-toggle="datepicker"]').datepicker('setStartDate', fechaOld);
									$('[data-toggle="datepicker"]').datepicker('setDate', fechaOld);
								}else{
									$('[data-toggle="datepicker"]').val('**-**-****');
									$('#slhour').val('--');
									$('#slmin').val('--');
									$('[data-toggle="datepicker"]').datepicker('setStartDate', new Date());
								}
								//fechacitasubc
							}else{
								$("#edfechacita").hide();
							}

							$("#fechaCita").html(fechaCita);
							$("#cntc").html(exp_contacto);
							$("#dir").html(direccion + " | " + localidad + " | " + codigoPostal);

							html = html + '<div class="w3-cell-row w3-mobile w3-container">';
							if (exp_telefono != "") {
								html = html + '<tr><td>Expediente</td><td class="numero">' + exp_telefono + '<td></tr>';

								$("#nophone").hide();
								$("#tlfnoselec").hide();

								$("#phone").show();
								$("#phone").attr('seleccionado', exp_telefono);
								// $("#mobincall").attr("href", "mobincube://action/call/" + "00" + exp_telefono);
								$("#tlfselec > span").html(exp_telefono);
								$("#tlfselec").show();
							}

							if (dir_telefono != "" && !isNaN(dir_telefono))
								html = html + '<tr><td>Dir. Teléfono</td><td class="numero">' + dir_telefono + '<td></tr>';
							if (dir_movil != "" && !isNaN(dir_movil))
								html = html + '<tr><td>Dir. Móvil</td><td class="numero">' + dir_movil + '<td></tr>';
							if (client_telefono != "" && !isNaN(client_telefono))
								html = html + '<tr><td>Cliente Teléfono</td><td class="numero">' + client_telefono + '<td></tr>';
							if (client_movil != "" && !isNaN(client_movil))
								html = html + '<tr><td>Cliente Móvil</td><td class="numero">' + client_movil + '<td></tr>';

							html = html + '</table>';

							$("#contactos").html(html);

							$(".numero").click(function() {
								var telefono = $(this).html();

								$("#nophone").hide();
								$("#tlfnoselec").hide();

								$("#phone").show();
								$("#phone").attr('seleccionado', telefono);
								// $("#mobincall").attr("href", "mobincube://action/call/" + "00"  + telefono);
								$("#tlfselec").hide("slow");
								$("#tlfselec > span").html(telefono);
								$("#tlfselec").slideDown("slow");
							});
						}
					},
					error: function(jqXHR, textStatus, errorThrown) {
						$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i> Error de acceso. El servidor no responde.');
					},
				});
			}else{ //navigator
				$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i> Conexión a Internet no disponible, por favor inténtelo más tarde.');
			}
			//eventos

			$("#phone").click(function() {
				// $("#seg_data").hide();
				var telefono = $("#phone").attr('seleccionado');

				if (telefono != '' || !phonenumber(telefono)) {

					// document.location.href = 'tel:' + telefono;
					// window.location.href = 'mobincube://action/call/' + encodeURIComponent(telefono);

					window.open('tel:' + telefono, "_blank");

					$("#phone").hide();
					$("#phonecall").show();

					$("#contactos").hide();

					$("#seg_form").show();
					$("#contenedor_items").hide();
				}
			});

			$("#phonecall").click(function() {
				var myDate = new Date();

				var subcont = localStorage.getItem(LOCALSUBC) === '1';

				var dateOld = fechaOldArr[0] + " | " + fechaOldArr[1];
				var dateNew = dateOld;

				var fechaNew = fechaOld;

				//recoger datos de observación
				var observaciones = '';
				var flag = true;
				var message = "";

				//se recoge el número de teléfono
				observaciones += 'El operario ha realizado una llamada al número ' + $("#phone").attr('seleccionado') + '.';

				//se comprueba si la llamada ha sido contestada
				if ($('input[name=llamada]:checked').val() == 'OK') {
					observaciones += ' La llamada ha sido contestada.';
				} else if ($('input[name=llamada]:checked').val() == 'KO') {
					observaciones += ' La llamada no ha sido contestada.';
				} else {
					flag = false;
					message += "<br />Se debe contestar si la llamada ha sido respondida o no"
				}

				if (subcont && $("#activechange").prop('checked')) {
					if ($('[data-toggle="datepicker"]').val() === '--/--/----' || $('#slhour').val() === '--' || $('#slmin').val() === '--') {
						flag = false;
						message += "<br />Si activa la edición de fecha de cita debe introducir una fecha"
					}else{
						// dateNewTmp = $('[data-toggle="datepicker"]').datepicker('getDate', true) + " | " + $('#slhour').val() + ":" + $('#slmin').val();
						fechaNew = $('[data-toggle="datepicker"]').datepicker('getDate');
						fechaNew.setHours($('#slhour').val(), $('#slmin').val(), 0, 0);
						if (fechaOld.getTime() == fechaNew.getTime()) {
							flag = false;
							message += "<br />Si activa la edición de fecha de cita debe introducir una fecha nueva";
						}else{
							flag = true;
						}
					}
				}

				var textseg = $("#textcita").val();

				if (textseg != '') {
					observaciones += ' El operario ha añadido las siguientes anotaciones: ' + textseg + '.';
				} else {
					observaciones += ' El operario no ha realizado ninguna anotación.';
				}


				if (flag) {
					if (navigator.onLine) {
						if (subcont && $("#activechange").prop('checked')) {
							var params = {
								"op": "llamadasubc",
								"token": token,
								"idExpEst": localStorage.getItem(LOCALIDEXPEST),
								"idSerie": idSerie,
								"numeroOrden": numeroOrden,
								"idOperario": localStorage.getItem(LOCALIDOP),
								"observaciones": observaciones,
								"fechaCitaOld": fechaOld.getTime()/1000,
								"fechaCitaNew": fechaNew.getTime()/1000,
								"cambiosubc": fechaOld.getTime() != fechaNew.getTime(),
								"subc": subcont
							};

							$.ajax({
								url: APIURL,
								data: params, //parámetros pasados
								type: 'POST',
								dataType: "json",
								crossDomain: true,
								success: function(jsonrespuesta) {
									if (jsonrespuesta.status == "KO") {
										switch (jsonrespuesta.error) {
											case "1":
												$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i>Error de base de datos: ' + jsonrespuesta.message + '.');
												break;
											case "99":
												logout(token,localStorage.getItem(LOCALIDOP));
												break;
											default:
												$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i> Ha ocurrido un error desconocido. Posiblemente necesite actualizar la aplicación');;

										}
									}
									if (jsonrespuesta.status == "OK") {
										location.reload(true);
									}
								},
								error: function(jqXHR, textStatus, errorThrown) {
									$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i> Error de acceso. El servidor no responde.');
								},
							});

						}else{
							var params = {
								"op": "nuevoseguimiento",
								"token": token,
								"idSerie": idSerie,
								"numeroOrden": numeroOrden,
								"idOperario": localStorage.getItem(LOCALIDOP),
								"observaciones": observaciones
							};
							$.ajax({
								url: APIURL,
								data: params, //parámetros pasados
								type: 'POST',
								dataType: "json",
								crossDomain: true,
								success: function(jsonrespuesta) {
									if (jsonrespuesta.status == "KO") {
										switch (jsonrespuesta.error) {
											case "1":
												$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i>Error de base de datos: ' + jsonrespuesta.message + '.');
												break;
											case "99":
												logout(token,localStorage.getItem(LOCALIDOP));
												break;
											default:
												$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i> Ha ocurrido un error desconocido. Posiblemente necesite actualizar la aplicación');;

										}
									}
									if (jsonrespuesta.status == "OK") {
										$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i> Anotaciones guardadas en Historial.');
									}
								},
								error: function(jqXHR, textStatus, errorThrown) {
									$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i> Error de acceso. El servidor no responde.');
								},
							});
						}

						$("#phone").show();
						$("#phonecall").hide();

						$("#contactos").show();

						$("#seg_form").hide();
						$("#contenedor_items").show();
					}else{ //navigator
						$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i> Conexión a Internet no disponible, por favor inténtelo más tarde.');
					}
				} else {
					$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i> ' + message);
				}
			});

			// $("#login > .opt").click(function() {
			// 	setDestinoTop($(this).attr('destino'));
			// });

			$("#login > .opt").click(function() {
				salirExped(finCita(), $(this).attr('destino')); //setDestinoTop
			});

			$("#navegador > #sections > .sect").click(function() {
				setDestinoNav($(this).attr('destino'));
			});



			$("#activechange").click(function() {
				if ($(this).prop('checked')) {
					$("#datepicker").prop('disabled', false);
					$("#slhour").prop('disabled', false);
					$("#slmin").prop('disabled', false);
					$("#llamadaOK").prop('checked', true)
				}else{
					$("#datepicker").prop('disabled', true);
					$("#slhour").prop('disabled', true);
					$("#slmin").prop('disabled', true);
				}
			});

			$("#llamadaKO").click(function() {
				if ($(this).prop('checked')) {
					$("#datepicker").prop('disabled', true);
					$("#slhour").prop('disabled', true);
					$("#slmin").prop('disabled', true);
					$("#activechange").prop('checked', false);
				}else{
				}
			});
		});
	</script>
</body>

</html>
