<!doctype html>
<html lang="es-ES">

<head>
	<meta charset="utf-8" />
	<meta http-equiv="x-ua-compatible" content="ie=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no" />
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" /><meta http-equiv="Last-Modified" content="0">
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />
	<title>Gestión de Intervenciones 1.0</title>
	<script src="./resources/js/jq.js"></script>

	<script type="text/javascript" src="./resources/js/gv.js"></script>

	<script type="text/javascript" src="cordova.js"></script>
	<script type="text/javascript" src="./resources/js/pg.js"></script>

	<script src="./resources/js/sp.js"></script>

	<link href="./resources/css/w3.css" rel="stylesheet">
	<link href="./resources/css/style.css" rel="stylesheet">
	<link href="./resources/fa/css/font-awesome.css" rel="stylesheet">
</head>

<body class="w3-large">
	<div id="top" class="w3-padding-large w3-large w3-red">
		<div id="titulo">

		</div>
		<div id="login">
			<a class="opt" destino="principal.html"><i class="fa fa-list" aria-hidden="true"></i></a>
			<a class="opt" destino="fest-general.html"><i class="fa fa-file-text-o " aria-hidden="true"></i></a>
			<a class="opt" destino="reload"><i class="fa fa-refresh" aria-hidden="true"></i></a>
			<a class="opt" destino="index.html"><i class="fa fa-power-off" aria-hidden="true"></i></a>
		</div>
	</div>
	<div id="info" class="w3-padding-large w3-border">

	</div>
	<div id="botones" class="w3-padding-large">
		<div id="navegador" class="w3-cell-row w3-center" style="width:100%">
			<div class="topnav" id="sections">
				<a class="sect disabled" destino="seguimiento.html">Observaciones</a>
				<a class="sect" destino="llamada.html">Llamada</a>
				<a class="sect" destino="historial.html">Historial</a>
				<a class="sect" destino="foto.html">Fotografías</a>
				<a class="sect" destino="planos.html">Planos/Diseños</a>
				<a class="sect" destino="parte.html">Parte Final</a>
				<a class="sect" destino="fincita.html">Fin Cita</a>
				<a id="val" class="sect" destino="val-general.html">Valoración/Presupuesto</a>
				<a href="javascript:void(0);" class="icon" onclick="showTopNav()"><i class="fa fa-bars" aria-hidden="true"></i></a>
			</div>
		</div>

		<div class="w3-light-grey w3-center w3-round w3-padding-16" style="width:100%;margin-bottom:16px;overflow:hidden">
			<div id="seg_form" class="w3-padding-large w3-center">
				<div>
					<h4>Introduzca las observaciones de necesarias</h4>
					<textarea id="textob" autocapitalize=characters class="textfield"></textarea>
					<button id="send" class="w3-button w3-block w3-green w3-cell w3-right">Enviar</button>
				</div>
			</div>
		</div>
	</div>
	<div id="modalexit" class="w3-light-grey w3-round w3-padding modalfull" style="width:100%;margin-bottom:16px">
		<div id="exitframe" class="campo">
			<input id="dest" type="text" name="dest" style="display:none;" disabled="disabled">
			<input id="type" type="text" name="dest" style="display:none;" disabled="disabled">
			<h4 id="mensaje"></h4>
			<button id="exittrue" class="w3-button w3-block w3-green w3-cell w3-right" style="width:50%">Salir</button>
			<button id="exitfalse" class="w3-button w3-block w3-red w3-cell w3-right" style="width:50%">Permanecer</button>
		</div>
	</div>
	<script>
		var token = "";
		var idSerie = "";
		var numeroOrden = "";

		$(document).ready(function() {

			//recoger parámetros
			token = gv_get_URL_parameter("token");
			idSerie = gv_get_URL_parameter("idSerie");
			numeroOrden = gv_get_URL_parameter("numeroOrden");

			if (localStorage.length = 0 || token === undefined || idSerie === undefined || numeroOrden === undefined || token == "" || idSerie == "" || numeroOrden == "") {
				logout(token,localStorage.getItem(LOCALIDOP));
			}


			idExpEst = localStorage.getItem(LOCALIDEXPEST);

			//rellenar página con parámetros
			$("#titulo").html("EXPEDIENTE " + idSerie + " " + numeroOrden);

			//eventos

			$("#send").click(function() {
				var myDate = new Date();

				var sendDate = myDate.getFullYear() + '-' + (myDate.getMonth() + 1) + '-' + myDate.getDate() + ' ' + myDate.getHours() + ":" + myDate.getMinutes() + ":" + myDate.getSeconds() + "." + myDate.getMilliseconds();


				//recoger datos de observación
				var observaciones = '';
				var flag = true;
				var message = "";

				//se recoge el número de teléfono

				var textseg = $("#textob").val();

				if (textseg != '') {
					observaciones += 'El operario ha añadido las siguientes anotaciones: ' + textseg + '.';
				} else {
					flag = false;
					message = "Debe introducir alguna observación";
				}

				if (flag) {
					if (navigator.onLine) {
						var params = {
							"op": "nuevoseguimiento",
							"token": token,
							"idSerie": idSerie,
							"numeroOrden": numeroOrden,
							"idOperario": localStorage.getItem(LOCALIDOP),
							"fecha": sendDate,
							"observaciones": observaciones
						};

						$.ajax({
							url: APIURL,
							data: params, //parámetros pasados
							type: 'POST',
							dataType: "json",
							crossDomain: true,
							success: function(jsonrespuesta) {
								if (jsonrespuesta.status == "KO") {
									switch (jsonrespuesta.error) {
										case "1":
											$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i>Error de base de datos: ' + jsonrespuesta.message + '.');
											break;
										case "99":
											logout(token,localStorage.getItem(LOCALIDOP));
											break;
										default:
											$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i> Ha ocurrido un error desconocido. Posiblemente necesite actualizar la aplicación');;

									}
								}
								if (jsonrespuesta.status == "OK") {
									$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i> Anotaciones guardadas en Historial.');
								}
							},
							error: function(jqXHR, textStatus, errorThrown) {
								$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i> Error de acceso. El servidor no responde.');
							},
						});
					}else{ //navigator
						$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i> Conexión a Internet no disponible, por favor inténtelo más tarde.');
					}
				} else {
					$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i> ' + message);
				}

			});

			// $("#login > .opt").click(function() {
			// 	setDestinoTop($(this).attr('destino'));
			// });
			//
			$("#login > .opt").click(function() {
				salirExped(finCita(), $(this).attr('destino')); //setDestinoTop
			});

			// $("#navegador > #sections > .sect").click(function() {
			// 	setDestinoNav($(this).attr('destino'));
			// });
			//
			$("#navegador > #sections > .sect").click(function() {
				//mostrar dialogo exit
				salirSection(!haySeg(), $(this).attr('destino')); //setDestinoNav
			});

			$('#textob').keyup(function() {
				$(this).val($(this).val().toUpperCase());
			});
		});

		$(document).on("click", '#modalexit *', function(event) {
			// alert($(this).attr('id'));

			if ($(this).attr('id') === "exittrue") {
				event.stopPropagation();
				// setDestinoNav($('#dest').val());
				switch ($('#type').val()) {
					case "setDestinoNav":
						setDestinoNav($('#dest').val());
						break;
					case "setDestinoTop":
						setDestinoTop($('#dest').val());
						break;
					default:
						event.stopPropagation();
						$("#modalexit").hide();

				}
			}else{
				event.stopPropagation();
				$("#modalexit").hide();
			}
		});
		function haySeg(){
			if ($("#textob").val() != '') {
				// alert(true);
				return true;
			}else{
				// alert(false);
				return false;
			}
		}
	</script>
</body>

</html>
