<!doctype html>
<html lang="es-ES">
<head>
<meta charset="utf-8"/>
<meta http-equiv="x-ua-compatible" content="ie=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
<title>Gestión de Intervenciones 1.0</title>
<script src="./resources/js/jq.js"></script>

<script src="./resources/js/gv.js"></script>
<script src="./resources/js/sp.js"></script>
<link href="./resources/css/w3.css" rel="stylesheet">
<link href="./resources/css/style.css" rel="stylesheet">
<link href="./resources/fa/css/font-awesome.css" rel="stylesheet">
<style>
	.element {
	  display: inline-flex;
	  align-items: center;
	}
	i.fa-camera {
	  margin: 10px;
	  cursor: pointer;
	  font-size: 30px;
	}
	i:hover {
	  opacity: 0.6;
	}
	input {
	  display: none;
	}
</style>
</head>
<body class="w3-large">
	<div id="top" class="w3-padding-large w3-large w3-red">
		<div id="titulo">
			
		</div>
		<div id="login">
			<a class="opt" destino="index.html"><i class="fa fa-power-off" aria-hidden="true"></i></a>
			<a class="opt" destino="reload"><i class="fa fa-refresh" aria-hidden="true"></i></a>
			<a class="opt" destino="principal.html"><i class="fa fa-list" aria-hidden="true"></i></a>
			<a class="opt" destino="fest-general.html"><i class="fa fa-file-text-o " aria-hidden="true"></i></a>
		</div>
	</div>
<div id="info" class="w3-padding-large w3-border">

</div>
<div id="contenedor_items" class="w3-padding-large">

	<div id="navegador" class="w3-cell-row w3-center"  style="width:100%">
		<div class="topnav" id="sections">
			<a class="sect disabled" destino="foto.html">Fotografías</a>
			<a class="sect" destino="llamada.html">Llamada</a>
			<a class="sect" destino="historial.html">Historial</a>
			<a class="sect" destino="seguimiento.html">Observaciones</a>
			<a class="sect" destino="planos.html">Planos/Diseños</a>
			<a id="val" class="sect" destino="val-general.html">Valoración/Presupuesto</a>
			<a class="sect" destino="parte.html">Parte Final</a>
			<a class="sect" destino="fincita.html">Fin Cita</a>
			<a href="javascript:void(0);" class="icon" onclick="showTopNav()"><i class="fa fa-bars" aria-hidden="true"></i></a>
		</div>
	</div>

	<div class="w3-light-grey w3-round w3-padding" style="width:100%;margin-bottom:16px">
		<div class="w3-cell-row w3-padding-16">
			<h4>Enviar Fotografías</h4>
			<i id="selbut" class="fa fa-camera"></i><span class="name">No hay imágenes seleccionadas</span>
			<input id="fileupload" name="img" type="file" accept="image/*" />
			<span id="imagesel">

			</span>
			<button id="send" class="w3-button w3-block w3-green w3-cell w3-right">Enviar</button>
		</div>
	</div>



</div>
<script>

var token="";
var idSerie = "";
var numeroOrden= "";

$(document).ready(function(){

	token=gv_get_URL_parameter("token");
	idSerie=gv_get_URL_parameter("idSerie");
	numeroOrden=gv_get_URL_parameter("numeroOrden");

	$("#titulo").html("EXPEDIENTE "+idSerie + " " + numeroOrden);


	//eventos
	$("#send").click(function() {
		var myDate = new Date();
		var files = $('#imagesel img');
		var filedata = [];
		var filenames = [];
		var filetipe = FILEFOTO;

		if (files.length!=0) {
			for (var i = 0; i < files.length; i++) {
				filedata[i]=files[i].src;
				filenames[i]="";
				filenames[i] += myDate.getFullYear();
				filenames[i] += '-' + (myDate.getMonth()+1);
				filenames[i] += '-' + myDate.getDate();

				filenames[i] += '-'+filetipe + i;

				console.log(filenames[i] + ": " + filedata[i]);
			}

			var params = {
				"op":"subirarch",
				"token": token,
				"idSerie":idSerie,
				"numeroOrden":numeroOrden,
				"idOperario": localStorage.getItem(LOCALIDOP),
				"filenames": filenames,
				"filedata": filedata
			};

			$.ajax({
				url: APIURL,
				data: params,//parámetros pasados
				type: 'POST',
				dataType : "json",
				crossDomain: true,
				success: function(jsonrespuesta) {
					// $("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i> Fotografías enviadas.');
					// $('#fileupload').siblings('span').html("No hay imágenes seleccionadas");
					// $('#imagesel').html("");
					// $("#fileupload").replaceWith($("#fileupload").val("").clone(true));
				},
				error: function(jqXHR, textStatus, errorThrown) {
					$("#info").html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i> Error de acceso. El servidor no responde.');
				},
			});
		}

	});

	$("#selbut").click(function () {
		$("#fileupload").trigger('click');
	});

	$('#fileupload').on('change', function() {
		var files = $(this)[0].files;
		$(this).siblings('span').html(files.length + "Imágenes Seleccionadas");
		$('#imagesel').html("");

		for (var i = 0; i < files.length; i++) {
			var reader = new FileReader();
			// $(this).siblings('span').append(files[i].name + "<br />");
			reader.onload = function (e, pos=i) {
				$('#imagesel').append("<span id='"+pos+"'><i class='fa fa-times' aria-hidden='true'></i></span>");
				// +e.target.result+
				var data = tipoimagen(e.target.result);

				if (data) {
					resizeBase64Img(data[1], 100, 100, data[0], pos).then(function(newImg){
					    $("#"+pos).append(newImg);
					});
				}
			}
			reader.readAsDataURL(files[i]);
		}
	});

	$("#login > .opt").click(function() {
		setDestinoTop($(this).attr('destino'));
	});

	$("#navegador > #sections > .sect").click(function() {
		setDestinoNav($(this).attr('destino'));
	});

	function tipo_data_img(base64){
		var ext='';
		var base64ext='';

		if (base64.includes(IMGTGIF[1])) {
			ext = IMGTGIF[0];
			base64ext = IMGTGIF[1];
		}else if (base64.includes(IMGTJPEG[1])) {
			ext = IMGTJPEG[0];
			base64ext = IMGTJPEG[1];
		}else if (base64.includes(IMGTPNG[1])) {
			ext = IMGTPNG[0];
			base64ext = IMGTPNG[1];
		}else {
			return false;
		}

		var data = new Array();
		data[0]=base64ext;
		data[1]=base64.replace('data:'+base64ext+';base64,', '');

		return data;
	}

	// function resizeBase64Img(base64, width, height, base64ext, id) {
	// 	var canvas = document.createElement("canvas");
	// 	canvas.width = width;
	// 	canvas.height = height;
	// 	var context = canvas.getContext("2d");
	// 	var deferred = $.Deferred();
	// 	// $('#imagesel').append("<span id='"+pos+"'><i class='fa fa-times' aria-hidden='true'></i><img src=''/></span>");
	// 	$("<img/>").attr("src", "data:"+ base64ext + ";base64," + base64).on("load", function() {
	// 		context.scale(width/this.width,  height/this.height);
     //    		context.drawImage(this, 0, 0);
	// 		deferred.resolve($("<img/>").attr("src", canvas.toDataURL()));
	// 	});
	// 	return deferred.promise();
	// }


});
</script>
</body>
</html>
